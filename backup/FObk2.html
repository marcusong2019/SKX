<!DOCTYPE html>
<html>
  <head>
    <title>Forward Observer</title>
    <script src="https://aframe.io/releases/1.1.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script> <!--AFrame extra for motion controls -->
    <script src="./Cesium.js"></script>
    <script src="./aframe-aterrain-component.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="./mgrs.js"></script>
    <script src="./observer.js"></script>
    <!-- foldable viewer config  using https://wwgc.firebaseapp.com/     http://google.com/cardboard/cfg?p=CgRXUFNDEg9Gb2xkYWJsZSBWaWV3ZXId9P1UPSW4HoU9KhAAAEhCAABIQgAASEIAAEhCWAE1KVwPPToImpkZPpqZGT5QAGAA -->
    <!--<script>
      // auto for demo and testing
      setTimeout(createTarget, 3000,100,0);//,"#T90Tank",180);
      setTimeout(createIDF, 7000,100,20);
      setTimeout(createIDF, 8000,300,-175);
      setTimeout(createIDF, 10000,100,100);
    </script>-->
    <script>
      AFRAME.registerComponent('ground-clamp', {
        schema: {
          height: {default: 0},
        },

    tick: function () {
        var position = this.el.object3D.position; //getAttribute('position');

        var location = new THREE.Vector3(position.x, 9000, position.z);
        const direction = new THREE.Vector3(0, -1, 0);
        const raycaster = new THREE.Raycaster();
        raycaster.set(location, direction);

        const mesh = document.querySelector("#ground").sceneEl.object3D;
        var intersects = raycaster.intersectObject(mesh, true);
        var point = intersects[0].point; // a three value point XYZ in world coord
        var Y = point.y + this.data.height;
        this.el.object3D.position.y=Y;      
}
  });
      
    </script>
  </head>
  <body>
    <a-scene background="color: #87ceeb">  
      <!-- Preload assets -->
      <a-assets>
        <a-asset-item
          id="M2Bradley"
          src="https://cdn.glitch.com/43148ef6-d50d-4e2d-9f92-9cdadde2d68a%2FM2Bradley.glb"
          response-type="arraybuffer"
        ></a-asset-item>

        <a-asset-item
          id="T90Tank"
          src="https://cdn.glitch.com/0140ff64-dac6-408d-bf59-c093dd13ad3a%2FT90.glb?v=1626968225914"
          response-type="arraybuffer"
        ></a-asset-item>
        <!-- https://www.cgtrader.com/items/3127302/download-page -->

        <a-asset-item
          id="lowTank"
          src="https://cdn.glitch.com/0140ff64-dac6-408d-bf59-c093dd13ad3a%2Flow_poly_2655945_tank.glb?v=1626967824598"
          response-type="arraybuffer"
        ></a-asset-item>

        <img
          id="crosshair"
          crossorigin="anonymous"
          src="https://cdn.glitch.com/43148ef6-d50d-4e2d-9f92-9cdadde2d68a%2FCrosshair3.png"
        />
        <img
          id="fire"
          crossorigin="anonymous"
          src="https://cdn.glitch.com/43148ef6-d50d-4e2d-9f92-9cdadde2d68a%2FDaco_4214507.png"
        />
        <img
          id="cloud"
          crossorigin="anonymous"
          src="https://cdn.glitch.com/0140ff64-dac6-408d-bf59-c093dd13ad3a%2FHEimpact2a.png"
        />
      </a-assets>

<a-entity
        id="camera-rig"
          ground-clamp
      >
  <!--TODO perhaps ground clamp to zero and put cameras at height 1.6 to accomodate the position tracking of headset -->
  <a-entity id="viewDirection" look-controls>
        <a-entity id="camera1" camera="zoom: 7;active:false" visible="false" position="0 1.6 0">
          <a-image
            src="#crosshair"
            position="0 0 -1"
            material="alphaTest: 0.5"
            scale="0.17 0.15 1"                              
          ></a-image>
          <!-- scale 0.14 is 1/7th -->
        </a-entity>
        <a-entity id="camera2" camera="active:true" position="0 1.6 0"></a-entity>
    </a-entity>
        <a-entity
          id="lefthand"
          vive-controls="hand: left"
          oculus-touch-controls="hand: left"
          windows-motion-controls="hand: left"          
        ></a-entity>
        <a-entity
          vive-controls="hand: right"
          oculus-touch-controls="hand: right"
          windows-motion-controls="hand: right"
        ></a-entity>
      </a-entity>

      <a-entity
        light="type: directional; color: #EED; intensity: 3"
        position="-1 1 1"
      ></a-entity>

      <a-entity
        id="ground"
        class="ground"
        a-terrain="fovpad:3;
                  latitude: 41.36289858633997;
                  longitude:-74.01923243991936;                     
                  elevation:0;
                  lod:15;"
      ></a-entity>
      <!-- above grid based on 18TWL8203079507 is
                  latitude: 41.36289858633997;
                  longitude:-74.01923243991936;  
          older tests at:
          41.36177634714477;
       -74.02275327296475; -->
    </a-scene>
  </body>
</html>
