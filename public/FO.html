<!DOCTYPE html>
<html>
  <head>
    <title>Forward Observer</title>
    <script src="https://aframe.io/releases/1.1.0/aframe.min.js"></script>
    <script src="./Cesium.js"></script>
    <script src="./aframe-aterrain-component.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script> <!--AFrame extra for motion controls -->
    <script src="https://unpkg.com/aframe-render-order-component@1.0.0/dist/aframe-render-order-component.min.js"></script> <!-- render order for transparent objects- smoke, fire https://npm.io/package/aframe-render-order-component-->
    <script src="/socket.io/socket.io.js"></script>
    <script src="./mgrs.js"></script>
    <script src="./observer.js"></script>
  </head>
  <body>
    <a-scene background="color: #87ceeb" render-order="background, foreground, fire, smoke, HUD" loading-screen="dotsColor: yellow; backgroundColor: black">     
      <!-- Preload assets -->
      <a-assets>        
        <img id="crosshair" crossorigin="anonymous" src="https://cdn.glitch.com/0140ff64-dac6-408d-bf59-c093dd13ad3a%2FCrosshair3.png?v=1629202456710">

        <a-asset-item
          id="T90Tank"
          src="https://cdn.glitch.global/0140ff64-dac6-408d-bf59-c093dd13ad3a/T90-Brout.glb?v=1652729924652"
          response-type="arraybuffer"
        ></a-asset-item>
        
        <a-asset-item
          id="soldier"
          src="https://cdn.glitch.global/cb84e525-00ad-44ef-8555-9970acb03bba/low_poly_soldier.glb?v=1652452882460"                      
          response-type="arraybuffer"
        ></a-asset-item> <!-- rescale glb with https://glb-scale-o-matic.glitch.me/ -->        
                
        <img
          id="fire"
          crossorigin="anonymous"
          src="https://cdn.glitch.com/0140ff64-dac6-408d-bf59-c093dd13ad3a%2FDaco_4214507.png?v=1629202720362"
        />
        <img
          id="cloud"
          crossorigin="anonymous"
          src="https://cdn.glitch.com/0140ff64-dac6-408d-bf59-c093dd13ad3a%2FHEimpact2a.png?v=1627049785796"
        />        
      </a-assets>
      
      <a-entity
              id="camera-rig"        
              movement-controls="controls: keyboard; camera: #viewDirection; speed:1;"
              ground-clamp="height:1.6;"
            >
        <!--TODO perhaps ground clamp to zero and put cameras at height 1.6 to accomodate the position tracking of headset -->
        <a-entity id="viewDirection" look-controls>
            <a-entity id="camera1" camera="zoom: 7;active:false" visible="false" render-order="HUD">
              <a-image
                src="#crosshair"
                position="0 0 -1"
                material="alphaTest: 0.5"
                scale="0.17 0.15 1"                              
              ></a-image>
              <!-- scale 0.14 is 1/7th -->
              <a-entity compass
                 id="compass-text"
                 text="value: abc; align: center" 
                 position="0 0.09 -1"
                 scale="0.5 0.5 0.5"></a-entity>
            </a-entity>
            <a-entity id="camera2" camera="active:true" ></a-entity>
        </a-entity>
            <a-entity
              id="lefthand"
              vive-controls="hand: left"
              oculus-touch-controls="hand: left"
              windows-motion-controls="hand: left"          
            ></a-entity>
            <a-entity
              vive-controls="hand: right"
              oculus-touch-controls="hand: right"
              windows-motion-controls="hand: right"
            ></a-entity>
      </a-entity>

      
      <a-box position="0 0 0" scale="0.5 1 0.5" color="red" render-order="foreground"></a-box>
      
      <a-entity
        light="type: directional; color: #EED; intensity: 1"
        position="-1 3 2"
      ></a-entity>
      <a-entity
        light="type: ambient; color: #FFF; intensity: 1"
      ></a-entity>
      
    </a-scene>

    <script>      
      document.addEventListener("keypress", function(e){
        console.log("keypress",e.keyCode);
        if(e.keyCode == 32) { //space bar
          swapCameras();     
        };
      });

      var isMobile = AFRAME.utils.device.isMobile();
      var isHeadset = AFRAME.utils.device.checkHeadsetConnected();
      console.log("Headset: " + isHeadset);

      if (isMobile) {
        console.log("mobile");
        document.addEventListener("click", swapCameras);
      }

      function swapCameras() {
        var mainCameraEl = document.querySelector('#camera1');
        var secondCameraEl = document.querySelector('#camera2');
        console.log("main cam",mainCameraEl.getAttribute('camera').active);
        if (mainCameraEl.getAttribute('camera').active) {
          mainCameraEl.setAttribute('camera', 'active', false);
          mainCameraEl.setAttribute('visible', false);
          secondCameraEl.setAttribute('camera', 'active', true);
        } else {
          mainCameraEl.setAttribute('camera', 'active', true);
          mainCameraEl.setAttribute('visible', true);
          secondCameraEl.setAttribute('camera', 'active', false);
        };
        console.log("swap cameras")
      }
    </script>
  </body>
</html>