<!DOCTYPE html>
<html>
  <head>
    <title>Forward Observer</title>
    <script src="https://aframe.io/releases/1.1.0/aframe.min.js"></script>
    <script src="./Cesium.js"></script>
    <script src="./aframe-aterrain-component.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script> <!--AFrame extra for motion controls -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="./mgrs.js"></script>
    <script src="./observer.js"></script>
  </head>
  <body>
    <a-scene background="color: #87ceeb">     
      <!-- Preload assets -->
      <a-assets>        
        <img id="crosshair" crossorigin="anonymous" src="https://cdn.glitch.com/0140ff64-dac6-408d-bf59-c093dd13ad3a%2FCrosshair3.png?v=1629202456710">

        <a-asset-item
          id="T90Tank"
          src="https://cdn.glitch.com/0140ff64-dac6-408d-bf59-c093dd13ad3a%2FT90.glb?v=1626968225914"
          response-type="arraybuffer"
        ></a-asset-item>
        <!-- https://www.cgtrader.com/items/3127302/download-page -->
        
        <img
          id="fire"
          crossorigin="anonymous"
          src="https://cdn.glitch.com/0140ff64-dac6-408d-bf59-c093dd13ad3a%2FDaco_4214507.png?v=1629202720362"
        />
        <img
          id="cloud"
          crossorigin="anonymous"
          src="https://cdn.glitch.com/0140ff64-dac6-408d-bf59-c093dd13ad3a%2FHEimpact2a.png?v=1627049785796"
        />        
      </a-assets>
      
<a-entity
        id="camera-rig"        
        movement-controls="camera: #viewDirection; speed:1;"
        ground-clamp="height:1.6;"
      >
  <!--TODO perhaps ground clamp to zero and put cameras at height 1.6 to accomodate the position tracking of headset -->
  <a-entity id="viewDirection" look-controls>
        <a-entity id="camera1" camera="zoom: 7;active:false" visible="false">
          <a-image
            src="#crosshair"
            position="0 0 -1"
            material="alphaTest: 0.5"
            scale="0.17 0.15 1"                              
          ></a-image>
          <!-- scale 0.14 is 1/7th -->
          <a-entity compass
             id="compass-text"
             text="value: abc; align: center" 
             position="0 0.09 -1"
             scale="0.5 0.5 0.5"></a-entity>
        </a-entity>
        <a-entity id="camera2" camera="active:true" ></a-entity>
    </a-entity>
        <a-entity
          id="lefthand"
          vive-controls="hand: left"
          oculus-touch-controls="hand: left"
          windows-motion-controls="hand: left"          
        ></a-entity>
        <a-entity
          vive-controls="hand: right"
          oculus-touch-controls="hand: right"
          windows-motion-controls="hand: right"
        ></a-entity>
      </a-entity>

      
      <a-box position="0 0 0" scale="0.5 1 0.5" color="red"></a-box>
      
      <a-entity
        light="type: directional; color: #EED; intensity: 3"
        position="-1 1 1"
      ></a-entity>
      
    </a-scene>

    <script>

        //setup terrain
        var sceneEl = document.querySelector("a-scene");
        var entityEl = document.createElement("a-entity");
        entityEl.setAttribute("id","ground");
        entityEl.setAttribute("class","ground");
        entityEl.setAttribute("static-body","");
        entityEl.setAttribute("a-terrain", "fovpad:5;elevation:0;lod:14;latitude:"+lat+";longitude:"+lon+";");
        sceneEl.appendChild(entityEl);
      
      //set camera
      var cameraRigEl = document.querySelector('#camera-rig');
      cameraRigEl.setAttribute("rotation","0 "+az+" 0");
      console.log("Camera Rig az",az);
      
      document.addEventListener("keypress", function(e){
  console.log("keypress",e.keyCode);
    if(e.keyCode == 32) { //space bar
      swapCameras();      
    };
});

/*if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){
  console.log("mobile");
  document.addEventListener("click", swapCameras);
}else{
  console.log("not mobile");
}*/

  var isMobile = AFRAME.utils.device.isMobile();
  var isHeadset = AFRAME.utils.device.checkHeadsetConnected();
  console.log("Headset: " + isHeadset);

  if (isMobile) {
    console.log("mobile");
    document.addEventListener("click", swapCameras);
  }


function swapCameras() {
  var mainCameraEl = document.querySelector('#camera1');
  var secondCameraEl = document.querySelector('#camera2');
  console.log("main cam",mainCameraEl.getAttribute('camera').active);
  if (mainCameraEl.getAttribute('camera').active) {
    mainCameraEl.setAttribute('camera', 'active', false);
    mainCameraEl.setAttribute('visible', false);
    secondCameraEl.setAttribute('camera', 'active', true);
  } else {
    mainCameraEl.setAttribute('camera', 'active', true);
    mainCameraEl.setAttribute('visible', true);
    secondCameraEl.setAttribute('camera', 'active', false);
  };
  console.log("swap cameras")
}
    </script>
  </body>
</html>

