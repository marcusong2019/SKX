<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Observed Fire Trainer</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://netdna.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
<style>
#gameScreen {
  display: none;
}
#scenarioScreen {
  display: none;
}  
  
body {font-family: Arial;}

/* Style the tab */
.tab {
  overflow: hidden;
  border: 1px solid #ccc;
  background-color: #f1f1f1;
}

/* Style the buttons inside the tab */
.tab button {
  background-color: inherit;
  float: left;
  border: none;
  outline: 1px solid #ccc;
  cursor: pointer;
  padding: 14px 0px;
  transition: 0.3s;
  /*font-size: 17px;*/
  width: 5.5rem;
}

/* Change background color of buttons on hover */
.tab button:hover {
  background-color: #ddd;
}

/* Create an active/current tablink class */
.tab button.active {
  background-color: #ccc;
}

/* Style the tab content */
.tabcontent {
  display: none;
  padding: 6px 12px;
  border: 1px solid #ccc;
  border-top: 1px solid #ccc;
  width: 24rem;
  height: 120px; 
}
  
  .center {
  margin-left: auto;
  margin-right: auto;
}
</style>
<style>
    /* 
    Extra small devices (portrait phones, less than 544px) 
    No media query since this is the default in Bootstrap because it is "mobile first"
    */
    h1 {font-size:2rem;} /*1rem = 16px*/
    h2 {font-size:1.5rem;}
    /*
    ####################################################
    M E D I A  Q U E R I E S
    ####################################################
    */

    /*
    ::::::::::::::::::::::::::::::::::::::::::::::::::::
    Bootstrap 4 breakpoints
    */
    /* Small devices (landscape phones, 544px and up) */


    /* Medium devices (tablets, 768px and up) The navbar toggle appears at this breakpoint */
    @media (min-width: 768px) {  
      h1 {font-size:2.5rem;} /*1rem = 16px*/
      h2 {font-size:2rem;}
    }

    /* Large devices (desktops, 992px and up) */

    /* Extra large devices (large desktops, 1200px and up) */
    @media (min-width: 1200px) {  
      h1 {font-size:3em;} /*1rem = 16px*/ 
      h2 {font-size:2.25rem;}
    }  
</style>
</head>
<body>
  <div class="alert alert-warning" role="alert">
  NOTICE: This is a prototype web app that is under active development. Expect changes to occur. You may encounter bugs. Send issues and suggestions to gordon dot cooke at westpoint dot edu.
  </div>
  <div class="alert alert-info alert-dismissible" role="alert"> Update v0.4.2: Improved layouts. New FOs aware of target hits when joining after start. Alerts if connection lost and improved attempts to reconnect. Bug fix on compass bearing. Bug fix on mobile layout.
    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  
  <section class="vh-100">
    <div class="container h-100">

      <div id="initialScreen" class="h-100">
        <div class="d-flex flex-column align-items-center justify-content-center h-100">
            <h1>Observed Fire Simulator</h1>
            <button
              type="submit"
              class="btn btn-success"
              id="newGameButton"
            >
              Create New FDC
            </button>
            <div>OR</div>
            <div class="form-group">
              <input type="text" placeholder="Enter FDC Code" id="gameCodeInput"/>
            </div>
            <button
              type="submit"
              class="btn btn-success"
              id="joinGameButton"
            >
              Join FDC as Observer
            </button>
          <br/>
          <div> <!-- Instruction area -->
            <button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapseExample" aria-expanded="false" aria-controls="collapseExample">
              Instructions
            </button>
            <div class="collapse" id="collapseExample">
              <div class="card card-body" style="height: 500px;">
                <div class="overflow-auto">
                <h4>Overview</h4>
                This simulation requires two users (or at least two instances of a web browser). One user acts as the Fire Direction Center (FDC) and inputs the fire missions.
                One or more other users connect to the same scenario as Forward Observers (FO). They will see a 3D rendering of the terrain and can observe round impacts. 
                By communicating with the FDC, the FO can practice requesting and adjusting indirect fire missions.
                
                <h4>Create a new FDC</h4>
                Click the green "Create New FDC" button to create a new training simulation. You will be shown the set of available scenarios.  Select the one you wish to use. 
                You will then be taken to the FDC game screen. The top of the screen has a QR code and game code. Give the game code, or show the QR code, to the forward observer(s).
                
                <h4>Join an FDC as a Forward Observer</h4>
                FOs can either follow a QR code directly to the scenario, or enter the game code and press the green "Join FDC as Observer" button to enter the simulation.
                You will see a loading screen with the key controls and a progress bar. If the loading screen is not displayed, or the screen hangs for a long time, refresh the page.
                
                <h4>FO View on Desktop</h4>
                You will see the view of the scene from the Observation Point (OP). Pressing the B key will toggle a 7x binocular view on and off. 
                The binoculars have a reticle simualting an M22 binocular. 
                Pressing the C key will toggle your compass. Press C once to bring up a compass, again to zoom in on the dial, and again to put away the compass.
                You can walk using the WASD keys, or the arrow keys. W to move forward; S for backward, A and D are left and right.
                Pressing the G key will toggle your GPS on and off. This will show you your current location in MGRS. Pressing space bar will bring you back to the main (normal eye) view.
                  
                <h4>
                  FO View on cell phones
                </h4>
                You can tap the screen to toggle between the "eye", compass, and binocular views. Slide your finger to rotate the view left, right. Or use the motion sensors to move your view (like binoculars).

                <h4>
                  FDC Game Controls
                </h4>
                Top of the screen shows the links and code that allow FOs to connect to your FDC. Provide these to you FOs so they can connect to your scenario.
                Below that are tabs for Grid, Polar, and Correction. Select the tab to provide inputs for that type of fire mission.
                <p>
                  Grid: Enter the MGRS grid coordinate for the requested fire mission. The easting and northing go in seperate boxes. You must use a 6, 8, or 10 digit grid (3, 4, or 5 digits in each box).
                </p>
                <p>
                  Polar: Enter the direction and distance for the requested fire mission. The app assumes the observer is located at the OP (where they spawned when entering the simulation.)
                </p>
                <p>
                  Correction: Enter the direction of view (in mils) along with the add/drop and left/right information (in meters). The app will adjust fire from the last fire mission's impact point.
                </p>
                <p>
                  Select the type of round to use from the drop down. Press the green Submit button to execute the fire mission. 
                  The app will send the impact almost immediately. You should press the button just after "Splash, Over".
                </p>
                <p>
                  The Fire For Effect button will send 5 rounds to the last fire mission's location (with some dispersion).
                </p>
                  <p>
                  The Reset button will revive all targets and remove all previous fire missions (smoke/dust) from the view.
                </p>
                <h4>
                  Comments, Issues, and Suggestions
                </h4>
                This web app is built by the West Point Simulation Center as a working prototype. It certainly has its problems. Send comments to Dr. Gordon Cooke: gordon dot cooke at westpoint dot edu.
                Suggestions for improvement, including feature requests for new use cases, are very welcome.
                <h4>
                  Credits
                </h4>  
                  <p>
                    "low poly soldier" (https://skfb.ly/o6qEO) by Kolos Studios is licensed under Creative Commons Attribution CC-BY (http://creativecommons.org/licenses/by/4.0/).
                  </p>
                  <p>
                    "Tank T90" (https://skfb.ly/o8J6G) by Brout is licensed under Creative Commons Attribution (http://creativecommons.org/licenses/by/4.0/).
                  </p>                  
                  <p>
                    "BTR 80" (https://skfb.ly/o8LHS) by Brout is licensed under Creative Commons Attribution (http://creativecommons.org/licenses/by/4.0/).
                  </p>
                </div>
              </div>
            </div>
          </div> <!-- Instruction area end -->
          <a href="https://cdn.glitch.global/0140ff64-dac6-408d-bf59-c093dd13ad3a/Map%20Extract.pdf?v=1658504677329">Download Map Sheets</a>
        </div>
      </div>
      
      <div id="scenarioScreen" class="h-100">
        
        
<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3">
          
          <div class="col">        
            <div class="card" style="width: 18rem;">
              <img src="https://cdn.glitch.com/0140ff64-dac6-408d-bf59-c093dd13ad3a%2FU.S._Military_Academy_Coat_of_Arms.svg.png?v=1626658887348" class="card-img-top" alt="West Point Thumbnail" height="200" width="200">
              <div class="card-body">
                <h5 class="card-title">West Point OP McNair</h5>
                <p class="card-text">Example scenario on West Point's artillery range terrain. <!--a href="https://cdn.glitch.global/0140ff64-dac6-408d-bf59-c093dd13ad3a/Map%20Extract.pdf?v=1652931424676">Download Map Sheet</a--></p>
                <button class="btn btn-primary" onclick="setScenario(0)">Select</button>
              </div>
            </div>
          </div>
          
          <div class="col">
            <div class="card" style="width: 18rem;">
              <center><img src="https://cdn.glitch.global/0140ff64-dac6-408d-bf59-c093dd13ad3a/USMA_SSI.png?v=1652970035647" class="card-img-top mh-100" alt="USMA Patch Thumbnail" style="width: 200px; height: 200px;"></center>
              <div class="card-body">
                <h5 class="card-title">West Point South</h5>
                <p class="card-text">This is a target rich environment with mounted and dismounted targets. OP located on the west slope of Cranberry Mountain at West Point. (18TWL8202178070)</p>
                <button class="btn btn-primary" onclick="setScenario(1)">Select</button>
              </div>
            </div>
          </div>
        
          <div class="col">
              <div class="card" style="width: 18rem;">
                <center><img src="https://cdn.glitch.global/0140ff64-dac6-408d-bf59-c093dd13ad3a/FA_School.png?v=1652968250533" class="card-img-top mh-100" alt="FA School Patch Thumbnail" style="width: 200px; height: 200px;"></center>
                <div class="card-body">
                  <h5 class="card-title">Ft Sill Tower 4 Ridge</h5>
                  <p class="card-text">OP located on Tower 4 Ridge, inside the artillery range. Tanks and dismounts to the front.</p>
                  <button class="btn btn-primary" onclick="setScenario(2)">Select</button>
                </div>
              </div>
          </div>
  
          <div class="col">
              <div class="card" style="width: 18rem;">
                <center><img src="https://cdn.glitch.global/0140ff64-dac6-408d-bf59-c093dd13ad3a/FA_School.png?v=1652968250533" class="card-img-top mh-100" alt="FA School Patch Thumbnail" style="width: 200px; height: 200px;"></center>
                <div class="card-body">
                  <h5 class="card-title">Ft Sill OB 11</h5>
                  <p class="card-text">OP is locted at Ft Sill's Observation Bunker 11 looking onto the artillery range. Several tank targets in the distance.</p>
                  <button class="btn btn-primary" onclick="setScenario(3)">Select</button>
                </div>
              </div>
          </div>
  
            <div class="col">
              <div class="card" style="width: 18rem;">
                <center><img src="https://cdn.glitch.global/0140ff64-dac6-408d-bf59-c093dd13ad3a/11ACR-200x200.png?v=1658499496961" class="card-img-top mh-100" alt="Blackhorse Patch Thumbnail" style="width: 200px; height: 200px;"></center>
                <div class="card-body">
                  <h5 class="card-title">Ft Irwin Hill 876</h5>
                  <p class="card-text">OP is locted on Hill 876 looking East. Three tank/motor platoons approaching.</p>
                  <button class="btn btn-primary" onclick="setScenario(4)">Select</button>
                </div>
              </div>
          </div>
  
          <div class="col">        
            <div class="card" style="width: 18rem;">
              <img src="https://cdn.glitch.com/ff04fad4-579c-40f2-b2d7-d1a5cf0a03be%2FMapSegment.png?v=1628971820083" class="card-img-top" alt="West Point Thumbnail" height="200" width="200">
              <div class="card-body">
                <h5 class="card-title">Custom Location</h5>
                <p class="card-text"> Enter MGRS grid (include grid zone designator) <br>    
                    <div class="form-group">
                      <input type="text" placeholder="18TWL81647945" id="gridInput" onkeyup="this.value = this.value.toUpperCase();"/> 
                      <label for="lookDirectionInput">Primary Direction:</label>
                      <select name="lookDirectionInput" id="lookDirectionInput">
                        <option value=0 selected>N</option>
                        <option value=800>NE</option>
                        <option value=1600>E</option>
                        <option value=2400>SE</option>
                        <option value=3200>S</option>
                        <option value=4000>SW</option>
                        <option value=4800>W</option>
                        <option value=5600>NW</option>
                      </select>
                    </div>
                </p>
                <button class="btn btn-primary" id="setMgrsGridButton">Submit</button>
              </div>
            </div>
          </div>
          
        </div>
      </div>

      <div id="gameScreen">
        <div class="d-flex flex-column align-items-center justify-content-center">
          <h2>Scenario: <span id="gameScenarioDisplay"></span></h2>
          <div>
            <a href="#" id="linkURL" target="_blank">
              <h2>Your game code is: <span id="gameCodeDisplay"></span></h2>
            </a>           
            <div class="collapse" id="collapseQR">
              <div id="qrcodeDisplay" class="d-flex flex-column align-items-center justify-content-center"></div>
            </div>            
          </div>
          <br>
          <div class="tab">
            <button class="tablinks" onclick="openAdjustFire(event, 'gridTab')" id="defaultOpen">Grid</button>
            <button class="tablinks" onclick="openAdjustFire(event, 'polarTab')">Polar</button>
            <button class="tablinks" onclick="openAdjustFire(event, 'correctionTab')">Correction</button>
            <button class="tablinks" onclick="openAdjustFire(event, 'settingsTab')">Settings</button>
          </div>

          <div id="gridTab" class="tabcontent align-items-center justify-content-center">
            <div class="form-group text-center">
              <b>Target:</b>
                <span id="gameGridDesignatorDisplay"></span> <input type="number" min="0" max="99999" placeholder="Easting" id="gridEastingInput"/>
                <input type="number" min="0" max="99999" placeholder="Northing" id="gridNorthingInput"/>
                <!-- maxlength="5" only works for text input type  -->
            </div>
          </div>
          <div id="polarTab" class="tabcontent align-items-center justify-content-center">
            <div class="form-group text-center">
                <label for="polarDirectionInput" class="font-weight-bold">Direction</label>
                <input type="number" min="0" max="6400" placeholder="mils" id="polarDirectionInput"/>
                <label for="polarDistanceInput" class="font-weight-bold">Distance</label>
                <input type="number" min="0" max="10000" placeholder="meters" id="polarDistanceInput"/>
            </div>
          </div>
          <div id="correctionTab" class="tabcontent align-items-center justify-content-center">
            <div class="form-group">
              <table class="center">
                <tr>
                  <th>
                    <label for="shiftDirectionInput">Direction</label>
                  </th><td>
                    <input type="number" min="0" max="6400" placeholder="mils" id="shiftDirectionInput"/>
                  </td>
                </tr>
                <tr>
                  <th>
                <label for="shiftDeviationInput">Deviation</label>
                    </th><td>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="correctDevLeftRight" id="correctDevLeft" value="left">
                  <label class="form-check-label" for="correctDevLeft">Left</label>
                </div>
                  </td><td>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="correctDevLeftRight" id="correctDevRight" value="right" checked>
                  <label class="form-check-label" for="correctDevRight">Right</label>
                </div>
                  </td><td>
                <input type="number" min="0" max="1000" placeholder="meters" id="shiftDeviationInput" style="width: 10ch"/>
                  </td>
                </tr>
                <!br>
                <tr>
                  <th>
                  <label for="shiftRangeInput">Range</label>
                    </th><td>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="correctRangeAddDrop" id="correctRangeAdd" value="add" checked>
                    <label class="form-check-label" for="correctRangeAdd">Add</label>
                  </div>
                  </td><td>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="correctRangeAddDrop" id="correctRangeDrop" value="drop">
                    <label class="form-check-label" for="correctRangeDrop">Drop</label>
                  </div>
                  </td><td>
                  <input type="number" min="-1000" max="1000" placeholder="meters" id="shiftRangeInput" style="width: 10ch"/>
                  </td>
                </tr>
              </table>
            </div>
          </div>
          <div id="settingsTab" class="tabcontent align-items-center justify-content-center">
            <!div class="form-group">
              <table class="center">
                <tr>
                  <th>
                    OP Location:
                  </th>
                  <td>
                    <span id="gameGridDesignatorDisplay2"></span> 
                    <input type="number" min="0" max="99999" placeholder="Easting" id="opEastingInput" style="width: 8ch"/>
                    <input type="number" min="0" max="99999" placeholder="Northing" id="opNorthingInput" style="width: 8ch"/>
                    <!-- maxlength="5" only works for text input type  -->
                    <button type="submit" class="btn btn-success" id="setOpButton" > Set </button>
                 </td>
                </tr>
                <tr>
                  <th>
                    G-M Angle:
                  </th>
                  <td>
                    <span id="gmAngleDisplay"></span> mils
                  </td>
                </tr>
                <tr>
                  <th>
                    Compass:
                  </th>
                  <td>
                    <select id="selectGmActive" onchange="updateCompassGM()">
                      <option value="magnetic">Magnetic North Compass</option>
                      <option value="grid">Grid North Compass</option>
                    </select>
                  </td>
                </tr>
              </table>
            </div>
          
          <div>
            <select id="roundTypeInput">
              <option value="HEPD" selected>High Explosive Quick</option>
              <option value="HEVT">High Explosive Variable Time</option>
              <!--<option value="HED">High Explosive Delay</option>-->
            </select>
            <button
              type="submit"
              class="btn btn-success"
              id="sendFireMissionButton"
              onclick="sendFireMission"
            >
              Submit
            </button>
          </div>
          
          <div>
            <h2 style="background-color:red;color:white"><span id="gameHitDisplay"></span></h2>
            <h2 style="background-color:yellow;color:black"><span id="gameWarningDisplay"></span></h2>
          </div>
          <div style="bg-info">
            <span id="sysMessageDisplay"></span>
          </div>
          
          <div class="py-3">
            <button class="btn btn-primary justify-content-center" type="button" data-toggle="collapse" data-target="#collapseQR" aria-expanded="false" aria-controls="collapseQR">
              QR Code
            </button>
            <button
              type="submit"
              class="btn btn-success"
              id="fireForEffectButton"
              onclick="fireForEffect"
            >
              Fire For Effect
            </button>
            <button
              type="submit"
              class="btn btn-success"
              id="resetButton"
              onclick="requestReset"
            >
              Reset
            </button>
            <button
              class="btn btn-danger"
              onclick="window.location.reload();"
            >
              Exit
            </button>
          </div>   
          <div class="form-group">
            <label for="fdcLogDisplay">Event Log:</label>
            <textarea id="fdcLogDisplay" rows="4" cols="50" readonly class="form-control">New Game</textarea>
          </div>
        </div>
      </div>
    </div>
</section>
  <script src="/socket.io/socket.io.js"></script>
  <script src="/qrcode.min.js"></script>
  <script src="./mgrs.js"></script>
  <script src="/main.js"></script>
</body>
</html>